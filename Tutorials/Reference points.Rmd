---
title: "Estimating reference points"
author: "Kyle L. Wilson"
date: "2025-10-11"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
      number_sections: true
    theme: journal
    highlight: espresso
    fig_retina: 3
    fig_caption: true
    fig_width: 7
    fig_height: 6
    smart: true
    df_print: tibble 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r source,echo=FALSE,warning = FALSE, message = FALSE}
library(mvtnorm)
library(marima)
library(diagram)
library(vioplot)
library(ggplot2)
```
## Population model
### Population dynamics

Our population is defined by as a species with a one year generation time with time-dynamics that follows birth (i.e., recruitment *R*) and death processes (i.e., fishing mortality *d*) such that:

\begin{align}
N_{t}=(1-d_{t})R_{t}
\end{align}

where $N_{i,t}$ is the number of adults at time *t*, $R_{i,t}$ is the number of recruits at time *t*, and $d_{t}$ is the fraction of recruits lost due to some source of mortliaty (i.e., harvest or disturbance).


### Beverton-Holt recruitment
Let's assume that our recruitment dynamics at time *t* depend on adult densities at *t-1*  following a reparameterized Beverton-Holt function based on compensation ratio [see Box 3.1 in @Walters2004] and ignoring age-structure so that we model adult-to-adult dynamics, i.e., setting $\phi_{E_{0}}=1$, $\phi_{B_{0}}=1$ and $R_0=N_0$ [see Table 3 in @Forrest2010]:

\begin{align}
R_{t}=\cfrac{{\alpha}N_{t-1}}{1+\cfrac{\alpha}{\beta}N_{t-1}}\epsilon_{t}
\end{align}

where $\alpha$ is the recruitment compensation ratio, $\beta$ is carrying capacity, and $\epsilon_{i,t}$ is lognormally distributed deviates to introduce stochastic recruitment dynamics.

```{r recruitment,echo=FALSE}
alpha <- c(2,4)
beta <- c(100,200)
```

For example, take a two different populations (Figure S1) that each vary in productivty $\alpha_1=2; \alpha_2=4$ and carrying capacity $\beta_1=100; \beta_2=200$. 

<br>
```{r recruit curves, echo=FALSE,warning = F, message = F,fig.hold=TRUE,fig.width=5.5, fig.height = 5,fig.cap="Density dependence in recruitment dynamics. Dashed line indicates the line of replacement, with equilbrium indicated by points. When populations fall below equilibrium points, per-capita productivity improves driving populations back towards equilibrium. When populations exceed their capacity, per-capita productivity decreases driving populations back towards equilibrium. At each point of the x-axis, the difference between the solid and dashed lines indicates the amount of recruitment above replacement, i.e., the surplus recruitment produced via compensatory density dependence.",fig.align="center"}
curve((alpha[1]*x)/(1+((alpha[1]-1)/beta[1])*x),from=0,to=2*beta[2],lwd=2,col="orange",xlab="Adults (t-1)",ylab="Recruits (t)",ylim=1.5*c(0,beta[2]),xlim=2*c(0,beta[2]))
curve((alpha[2]*x)/(1+((alpha[2]-1)/beta[2])*x),from=0,to=2*beta[2],lwd=2,col="dodgerblue",add=TRUE)
abline(b=1,a=0,lty=3,lwd=1.5,col="grey50")

curvedarrow(from=c(0.4*beta[2],0.75*beta[2]),to=c(beta[2],beta[2]),lwd=2,lty=1,lcol="black",arr.col="black",curve=-0.075,endhead=TRUE,arr.pos=0.5)
curvedarrow(from=c(1.575*beta[2],1.1*beta[2]),to=c(beta[2],beta[2]),lwd=2,lty=1,lcol="black",arr.col="black",curve=0.075,endhead=TRUE,arr.pos=0.5)

text(x=0.45*beta[2],y=0.88*beta[2],"Increased productivity",cex=0.5,srt=25)
text(x=1.60*beta[2],y=1.20*beta[2],"Decreased productivity",cex=0.5,srt=8.5)

points(c(beta),c(beta),pch=21,bg=c("orange","dodgerblue"))
legend("bottomright",c("Population 1","Population 2","Replacement"),bty="n",lwd=1.5,lty=c(1,1,3),pch=c(NA,NA,21),col=c("orange","dodgerblue","grey50"),pt.bg="grey50",cex=0.8)

```

### Recruitment stochasticity
We can model stochastic recruitment and, in this case, we will use a lognormal distribution with average variation in recruitment of $\sigma_R$. In cases with stochastic recruitment, the deterministic recruitment in eq. S.4 becomes:

\begin{align}
R_{t}=\cfrac{{\alpha}N_{t-1}}{1+\cfrac{{\alpha}}{\beta}N_{t-1}}e^{\epsilon_{t}-\cfrac{\sigma_{R}^2}{2}}
\end{align}

where lognormal deviates at time *t* is drawn from a normal distribution (*N*) with bias correction $\cfrac{\sigma_{R}^2}{2}$. If $\sigma_R$ is low, then population dynamics approach the deterministic case. In some scenarios, we may want to evaluate the role of temporally correlated recruitment deviates to model potential drivers synchronous or correlated dynamics. Expected recruitment deviates can follow a first-order autoregressive model such that:

\begin{align}
\epsilon_{t}=\rho\epsilon_{t-1}+N(\mu=0,\sigma=\sqrt{\sigma_R^2(1-\rho^2)})
\end{align}


where $\rho$ is temporal correlation (bounded $0-1$). If $\rho$ is 0, then annual recruitment deviates were independent. We modelled the initial conditions for autoregressive recruitment deviates $\epsilon_{1}$ by drawing from a stationary normal distribution with mean $\mu=0$ and variance $\sigma_R^2$ such that:
\begin{align}
\epsilon_{1} \sim N(\mu=0,\sigma=\sigma_R)
\end{align}
We illustrate the effects of two kinds of recruitment deviates below using the same random number generator seed:

```{r recruitment stochasticity, echo=FALSE, warning=FALSE, message = FALSE,fig.width=10,fig.height=5}
Nyears <- 50
seed <- 2025
rho <- 0.8
sigma_r <- 0.5
alpha <- 5
beta <- 200
set.seed(seed)
epsilon <- rnorm(Nyears,mean=0,sd=sigma_r)
N <- recruits <- rep(NA,Nyears)
N[1] <- beta
recruits[1] <- alpha*N[1]/(1+((alpha-1)/beta)*N[1])*exp(epsilon[1])
for(t in 2:Nyears)
{
  N[t] <- recruits[t-1]
  recruits[t] <- alpha*N[t]/(1+((alpha-1)/beta)*N[t])*exp(epsilon[t]-(sigma_r^2)/2)
}
layout(matrix(1:2,ncol=2))
plot(1:Nyears,recruits,xlab="Time",ylim=range(c(0,recruits)),type="l")
plot(N,recruits,xlim=range(c(0,N)),ylim=range(c(0,recruits)))
curve((alpha*x)/(1+((alpha-1)/beta)*x),from=0,lwd=2,col="dodgerblue",add=TRUE)
head(data.frame("Adults"=N,"Recruits"=recruits))

print(c("sd in simulated recruitment (independent)",round(sd(epsilon),2)))

set.seed(seed)
epsilon <- rnorm(1,mean=0,sd=sigma_r)
N <- recruits <- rep(NA,Nyears)
N[1] <- beta
recruits[1] <- alpha*N[1]/(1+((alpha-1)/beta)*N[1])*exp(epsilon[1])
for(t in 2:Nyears)
{
  epsilon[t] <- rho*epsilon[t-1] + rnorm(1,mean=0,sd=sqrt((sigma_r^2)*(1-rho^2)))
  N[t] <- recruits[t-1]
  recruits[t] <- alpha*N[t]/(1+((alpha-1)/beta)*N[t])*exp(epsilon[t]-(sigma_r^2)/2)
}

layout(matrix(1:2,ncol=2))
plot(1:Nyears,recruits,xlab="Time",ylim=range(c(0,recruits)),type="l")
plot(N,recruits,xlim=range(c(0,N)),ylim=range(c(0,recruits)))
curve((alpha*x)/(1+((alpha-1)/beta)*x),from=0,lwd=2,col="dodgerblue",add=TRUE)
head(data.frame("Adults"=N,"Recruits"=recruits))

print(c("sd in simulated recruitment (correlated)",round(sd(epsilon),2)))

```